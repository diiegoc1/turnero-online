<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Boxicons -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link href='https://unpkg.com/boxicons@2.1.4/dist/boxicons.js' rel='stylesheet'>

    <!-- Material Icons para el calendario -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- My CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- Fuentes para el calendario -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

       
    <title>Administrador</title>
</head>

<body>
    <!-- SIDEBAR -->
    <section id="sidebar">
        <a href="#" class="brand">
            <i class='bx bxs-smile  bx-lg'></i>
            <span class="text">Modo Admin</span>
        </a>
        <ul class="side-menu top">
            <li class="active" data-page="dashboard">
                <a href="#">
                    <i class='bx bxs-dashboard bx-sm'></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>
            <li data-page="calendario">
                <a href="#">
                    <i class='bx bxs-shopping-bag-alt bx-sm'></i>
                    <span class="text">Calendario</span>
                </a>
            </li>
            <li>
                <a href="#">
                    <i class='bx bxs-doughnut-chart bx-sm'></i>
                    <span class="text">Analiticas</span>
                </a>
            </li>
        </ul>
        <ul class="side-menu bottom">
            <li>
                <a href="#">
                    <i class='bx bxs-cog bx-sm bx-spin-hover'></i>
                    <span class="text">Configuración</span>
                </a>
            </li>
            <li>
                <a href="#" class="logout">
                    <i class='bx bx-power-off bx-sm bx-burst-hover'></i>
                    <span class="text">Cerrar Sesión</span>
                </a>
            </li>
        </ul>
    </section>
    <!-- SIDEBAR -->

    <!-- CONTENT -->
    <section id="content">
        <!-- NAVBAR -->
        <nav>
            <i class='bx bx-menu bx-sm'></i>
            <input type="checkbox" class="checkbox" id="switch-mode" hidden />
            <label class="swith-lm" for="switch-mode">
                <i class="bx bx-sun"></i>
                <i class="bx bxs-moon"></i>
                <div class="ball"></div>
            </label>
        </nav>
        <!-- NAVBAR -->

        <!-- MAIN -->
        <main>
            <!-- Contenido del Dashboard -->
            <div id="dashboard-content">
                <div class="head-title">
                    <div class="left">
                        <h1>Dashboard</h1>
                        <ul class="breadcrumb">
                            <li>
                                <a href="#">Dashboard</a>
                            </li>
                            <li><i class='bx bx-chevron-right'></i></li>
                            <li>
                                <a class="active" href="#">Inicio</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <ul class="box-info">
                    <li>
                        <i class='bx bxs-calendar-check'></i>
                        <span class="text">
                            <h3>10</h3>
                            <p>Nuevos turnos</p>
                        </span>
                    </li>
                    <li>
                        <i class='bx bxs-dollar-circle'></i>
                        <span class="text">
                            <h3>$2.543.000</h3>
                            <p>Ventas totales</p>
                        </span>
                    </li>
                </ul>

                <div class="table-data">
                    <div class="order">
                        <div class="head">
                            <h3>Turnos recientes</h3>
                            <i class='bx bx-search'></i>
                            <i class='bx bx-filter'></i>
                        </div>
                        <table>
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Hora</th>
                                    <th>Servicio</th>
                                    <th>Precio</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody>
                                
                            </tbody>
                        </table>
                        <ul id="turnos"></ul>
                    </div>
                </div>
            </div>

            
            <div id="calendario-content" class="hidden-content">
                <div class="head-title">
                    <div class="left">
                        <h1>Calendario</h1>
                        <ul class="breadcrumb">
                            <li>
                                <a href="#">Dashboard</a>
                            </li>
                            <li><i class='bx bx-chevron-right'></i></li>
                            <li>
                                <a class="active" href="#">Calendario</a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="calendar-container">
                    <div class="calendar-wrapper">
                        <div class="header-background">
                            <div class="calendar-header">
                                <a class="prev-button" id="prev">
                                    <i class="material-icons">keyboard_arrow_left</i>
                                </a>
                                <a class="next-button" id="next">
                                    <i class="material-icons">keyboard_arrow_right</i>
                                </a>
                                <div class="row header-title">
                                    <div class="header-text">
                                        <h3 id="month-name">Febrero</h3>
                                        <h5 id="todayDayName">Hoy es Viernes 7 Feb</h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="calendar-content">
                            <div id="calendar-table" class="calendar-cells">
                                <div id="table-header">
                                    <div class="row">
                                        <div class="col">Lun</div>
                                        <div class="col">Mar</div>
                                        <div class="col">Mie</div>
                                        <div class="col">Jue</div>
                                        <div class="col">Vie</div>
                                        <div class="col">Sab</div>
                                        <div class="col">Dom</div>
                                    </div>
                                </div>
                                <div id="table-body" class=""></div>
                            </div>
                        </div>

                        <div class="calendar-events-container">
                            <div class="calendar-events-header">
                                <h4 id="eventDayName">Eventos del día</h4>
                            </div>
                            <div class="calendar-events" id="sidebarEvents">
                                <div class="empty-message">No hay eventos para la fecha seleccionada</div>
                            </div>
                        </div>

                        <div class="calendar-footer">
                            <div class="emptyForm" id="emptyForm">
                                <h4 id="emptyFormTitle">No hay eventos</h4>
                                <a class="addEvent" id="changeFormButton">Agregar nuevo</a>
                            </div>
                            <div class="addForm" id="addForm">
                                <h4>Agregar nuevo evento</h4>
                                <div class="row">
                                    <div class="input-field col s6">
                                        <input id="eventTitleInput" type="text" class="validate" required>
                                        <label for="eventTitleInput">Título</label>
                                    </div>
                                    <div class="input-field col s6">
                                        <input id="eventDescInput" type="text" class="validate" required>
                                        <label for="eventDescInput">Descripción</label>
                                    </div>
                                </div>
                                <div class="addEventButtons">
                                    <a class="waves-effect waves-light btn blue lighten-2"
                                        id="addEventButton">Agregar</a>
                                    <a class="waves-effect waves-light btn grey lighten-2" id="cancelAdd">Cancelar</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!-- MAIN -->
    </section>
    <!-- CONTENT -->

    <!-- jQuery para el calendario -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

    <script src="script.js"></script>

    <script>
        // Código para cargar los turnos
        fetch('http://localhost:3000/turnos')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error en la respuesta del servidor');
                }
                return response.json();
            })
            .then(data => {
                console.log('Datos recibidos:', data);
                const tbody = document.querySelector('tbody');

                // Limpiar el tbody antes de agregar nuevos datos
                tbody.innerHTML = '';

                data.forEach(turno => {
                    const tr = document.createElement('tr');

                    // Formatear la fecha
                    const fechaFormateada = formatFecha(turno.fecha);
                    const horaFormateada = formatHora(turno.hora);

                    // Crear las celdas con el formato de tu tabla
                    tr.innerHTML = `
                    <td>
                        <p>${turno.cliente_nombre || 'Sin nombre'}</p>
                    </td>
                    <td>${fechaFormateada}</td>
                    <td>${horaFormateada}</td>
                    <td>${turno.servicio || 'Sin servicio'}</td>
                    <td>$${turno.precio || '0'}</td>
                    <td><span class="status ${getStatusClass(turno.estado)}">${turno.estado || 'Sin estado'}</span></td>
                `;

                    tbody.appendChild(tr);
                });

                // Actualizar el contador de turnos
                updateTurnosCount(data.length);
            })
            .catch(err => {
                console.error('Error fetching data:', err);
                // Mostrar mensaje de error en la tabla
                const tbody = document.querySelector('tbody');
                tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; color: red; padding: 20px;">
                        Error al cargar los turnos: ${err.message}
                    </td>
                </tr>
            `;
            });

        // Función para formatear fecha de ISO a DD-MM-YYYY
        function formatFecha(fechaISO) {
            if (!fechaISO) return 'Sin fecha';

            try {
                const fecha = new Date(fechaISO);
                if (isNaN(fecha.getTime())) return fechaISO; // Si no es una fecha válida

                const dia = fecha.getDate().toString().padStart(2, '0');
                const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
                const anio = fecha.getFullYear();

                return `${dia}-${mes}-${anio}`;
            } catch (error) {
                console.error('Error formateando fecha:', error);
                return fechaISO; // Devolver original si hay error
            }
        }

       
        function formatHora(hora) {
            if (!hora) return 'Sin hora';

            // Si la hora viene en formato ISO (con T y Z)
            if (hora.includes('T') && hora.includes('Z')) {
                try {
                    const fechaHora = new Date(hora);
                    if (isNaN(fechaHora.getTime())) return hora;

                    return fechaHora.toLocaleTimeString('es-AR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        hour12: false
                    });
                } catch (error) {
                    return hora;
                }
            }

            // Si ya viene en formato HH:MM:SS, tomar solo HH:MM
            if (hora.includes(':')) {
                return hora.split(':').slice(0, 2).join(':');
            }

            return hora;
        }

        // Función para determinar la clase CSS según el estado
        function getStatusClass(estado) {
            if (!estado) return 'pending';

            const estadoLower = estado.toLowerCase();
            if (estadoLower.includes('complet') || estadoLower.includes('confirm')) return 'completed';
            if (estadoLower.includes('pendient') || estadoLower.includes('espera')) return 'pending';
            if (estadoLower.includes('proces') || estadoLower.includes('en curso')) return 'process';
            if (estadoLower.includes('cancel')) return 'cancelled';

            return 'pending';
        }

        // Función para actualizar el contador de turnos
        function updateTurnosCount(count) {
            const turnosCountElement = document.querySelector('.box-info li:first-child h3');
            if (turnosCountElement) {
                turnosCountElement.textContent = count;
            }
        }

        // Script para cambiar entre dashboard y calendario
        document.addEventListener('DOMContentLoaded', function () {
            const menuItems = document.querySelectorAll('.side-menu.top li');
            const dashboardContent = document.getElementById('dashboard-content');
            const calendarioContent = document.getElementById('calendario-content');

            menuItems.forEach(item => {
                item.addEventListener('click', function () {
                    const page = this.getAttribute('data-page');

                    if (!page) return;

                    // Remover clase active de todos los items
                    menuItems.forEach(i => i.classList.remove('active'));
                    // Agregar clase active al item clickeado
                    this.classList.add('active');

                    // Mostrar el contenido correspondiente
                    if (page === 'dashboard') {
                        dashboardContent.classList.remove('hidden-content');
                        calendarioContent.classList.add('hidden-content');
                    } else if (page === 'calendario') {
                        dashboardContent.classList.add('hidden-content');
                        calendarioContent.classList.remove('hidden-content');
                        // Inicializar calendario si es necesario
                        initCalendar();
                    }
                });
            });
        });

        function initCalendar() {
           
            var calendar = document.getElementById("calendar-table");
            var gridTable = document.getElementById("table-body");
            var currentDate = new Date();
            var selectedDate = currentDate;
            var selectedDayBlock = null;
            var globalEventObj = {};

            var sidebar = document.getElementById("sidebar");

            function createCalendar(date, side) {
                var currentDate = date;
                var startDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);

                var monthTitle = document.getElementById("month-name");
                var monthName = currentDate.toLocaleString("es-ES", {
                    month: "long"
                });
                var yearNum = currentDate.toLocaleString("es-ES", {
                    year: "numeric"
                });
                monthTitle.innerHTML = `${monthName} ${yearNum}`;

                if (side == "left") {
                    gridTable.className = "animated fadeOutRight";
                } else {
                    gridTable.className = "animated fadeOutLeft";
                }

                setTimeout(() => {
                    gridTable.innerHTML = "";

                    var newTr = document.createElement("div");
                    newTr.className = "row";
                    var currentTr = gridTable.appendChild(newTr);

                    for (let i = 1; i < (startDate.getDay() || 7); i++) {
                        let emptyDivCol = document.createElement("div");
                        emptyDivCol.className = "col empty-day";
                        currentTr.appendChild(emptyDivCol);
                    }

                    var lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                    lastDay = lastDay.getDate();

                    for (let i = 1; i <= lastDay; i++) {
                        if (currentTr.children.length >= 7) {
                            currentTr = gridTable.appendChild(addNewRow());
                        }
                        let currentDay = document.createElement("div");
                        currentDay.className = "col";
                        if (selectedDayBlock == null && i == currentDate.getDate() || selectedDate.toDateString() == new Date(currentDate.getFullYear(), currentDate.getMonth(), i).toDateString()) {
                            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);

                            document.getElementById("eventDayName").innerHTML = selectedDate.toLocaleString("es-ES", {
                                month: "long",
                                day: "numeric",
                                year: "numeric"
                            });

                            selectedDayBlock = currentDay;
                            setTimeout(() => {
                                currentDay.classList.add("blue");
                                currentDay.classList.add("lighten-3");
                            }, 900);
                        }
                        currentDay.innerHTML = i;

                        //show marks
                        if (globalEventObj[new Date(currentDate.getFullYear(), currentDate.getMonth(), i).toDateString()]) {
                            let eventMark = document.createElement("div");
                            eventMark.className = "day-mark";
                            currentDay.appendChild(eventMark);
                        }

                        currentTr.appendChild(currentDay);
                    }

                    for (let i = currentTr.getElementsByTagName("div").length; i < 7; i++) {
                        let emptyDivCol = document.createElement("div");
                        emptyDivCol.className = "col empty-day";
                        currentTr.appendChild(emptyDivCol);
                    }

                    if (side == "left") {
                        gridTable.className = "animated fadeInLeft";
                    } else {
                        gridTable.className = "animated fadeInRight";
                    }

                    function addNewRow() {
                        let node = document.createElement("div");
                        node.className = "row";
                        return node;
                    }

                }, !side ? 0 : 270);
            }

            createCalendar(currentDate);

            var todayDayName = document.getElementById("todayDayName");
            todayDayName.innerHTML = "Today is " + currentDate.toLocaleString("es-ES", {
                weekday: "long",
                day: "numeric",
                month: "short"
            });

            var prevButton = document.getElementById("prev");
            var nextButton = document.getElementById("next");

            prevButton.onclick = function changeMonthPrev() {
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1);
                createCalendar(currentDate, "left");
            }
            nextButton.onclick = function changeMonthNext() {
                currentDate = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1);
                createCalendar(currentDate, "right");
            }

            function addEvent(title, desc) {
                if (!globalEventObj[selectedDate.toDateString()]) {
                    globalEventObj[selectedDate.toDateString()] = {};
                }
                globalEventObj[selectedDate.toDateString()][title] = desc;
            }

            function showEvents() {
                let sidebarEvents = document.getElementById("sidebarEvents");
                let objWithDate = globalEventObj[selectedDate.toDateString()];

                sidebarEvents.innerHTML = "";

                if (objWithDate) {
                    let eventsCount = 0;
                    for (key in globalEventObj[selectedDate.toDateString()]) {
                        let eventContainer = document.createElement("div");
                        eventContainer.className = "eventCard";

                        let eventHeader = document.createElement("div");
                        eventHeader.className = "eventCard-header";

                        let eventDescription = document.createElement("div");
                        eventDescription.className = "eventCard-description";

                        eventHeader.appendChild(document.createTextNode(key));
                        eventContainer.appendChild(eventHeader);

                        eventDescription.appendChild(document.createTextNode(objWithDate[key]));
                        eventContainer.appendChild(eventDescription);

                        let markWrapper = document.createElement("div");
                        markWrapper.className = "eventCard-mark-wrapper";
                        let mark = document.createElement("div");
                        mark.className = "eventCard-mark";
                        markWrapper.appendChild(mark);
                        eventContainer.appendChild(markWrapper);

                        sidebarEvents.appendChild(eventContainer);

                        eventsCount++;
                    }
                    let emptyFormMessage = document.getElementById("emptyFormTitle");
                    emptyFormMessage.innerHTML = `${eventsCount} eventos programados`;
                } else {
                    let emptyMessage = document.createElement("div");
                    emptyMessage.className = "empty-message";
                    emptyMessage.innerHTML = "No hay eventos para la fecha seleccionada";
                    sidebarEvents.appendChild(emptyMessage);
                    let emptyFormMessage = document.getElementById("emptyFormTitle");
                    emptyFormMessage.innerHTML = "No hay eventos";
                }

                // Actualizar el encabezado de eventos con la fecha seleccionada
                document.getElementById("eventDayName").innerHTML = "Eventos para " + formatDate(selectedDate);
            }

            // Función auxiliar para formatear fecha en español
            function formatDate(date) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('es-ES', options);
            }

            gridTable.onclick = function (e) {

                if (!e.target.classList.contains("col") || e.target.classList.contains("empty-day")) {
                    return;
                }

                if (selectedDayBlock) {
                    if (selectedDayBlock.classList.contains("blue") && selectedDayBlock.classList.contains("lighten-3")) {
                        selectedDayBlock.classList.remove("blue");
                        selectedDayBlock.classList.remove("lighten-3");
                    }
                }
                selectedDayBlock = e.target;
                selectedDayBlock.classList.add("blue");
                selectedDayBlock.classList.add("lighten-3");

                selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), parseInt(e.target.innerHTML));
                gridTable.onclick = function (e) {
                    if (!e.target.classList.contains("col") || e.target.classList.contains("empty-day")) {
                        return;
                    }

                    if (selectedDayBlock) {
                        if (selectedDayBlock.classList.contains("blue") && selectedDayBlock.classList.contains("lighten-3")) {
                            selectedDayBlock.classList.remove("blue");
                            selectedDayBlock.classList.remove("lighten-3");
                        }
                    }
                    selectedDayBlock = e.target;
                    selectedDayBlock.classList.add("blue");
                    selectedDayBlock.classList.add("lighten-3");

                    selectedDate = new Date(
                        currentDate.getFullYear(),
                        currentDate.getMonth(),
                        parseInt(e.target.innerHTML)
                    );

                    showEvents();


                };

            }

            var changeFormButton = document.getElementById("changeFormButton");
            var addForm = document.getElementById("addForm");
            var emptyForm = document.getElementById("emptyForm");
            changeFormButton.onclick = function (e) {
                e.preventDefault();
                emptyForm.style.display = "none";
                addForm.classList.add("active");
            };

            var cancelAdd = document.getElementById("cancelAdd");
            cancelAdd.onclick = function (e) {
                e.preventDefault();
                addForm.classList.remove("active");
                setTimeout(function () {
                    emptyForm.style.display = "block";
                }, 300);

                // Limpiar campos
                document.getElementById("eventTitleInput").value = "";
                document.getElementById("eventDescInput").value = "";

                // Restablecer etiquetas
                var labels = document.querySelectorAll('.addForm label');
                labels.forEach(function (label) {
                    label.style.top = "-20px";
                    label.style.fontSize = "1rem";
                    label.style.opacity = "0.8";
                });
            };

            var addEventButton = document.getElementById("addEventButton");
            addEventButton.onclick = function (e) {
                e.preventDefault();
                let title = document.getElementById("eventTitleInput").value.trim();
                let desc = document.getElementById("eventDescInput").value.trim();

                if (!title || !desc) {
                    // Mostrar mensaje de error con un efecto
                    alert("Por favor, complete todos los campos");
                    return;
                }

                addEvent(title, desc);
                showEvents();

                if (!selectedDayBlock.querySelector(".day-mark")) {
                    selectedDayBlock.appendChild(document.createElement("div")).className = "day-mark";
                }

                // Limpiar formulario
                document.getElementById("eventTitleInput").value = "";
                document.getElementById("eventDescInput").value = "";

                // Ocultar formulario y mostrar emptyForm
                addForm.classList.remove("active");
                setTimeout(function () {
                    emptyForm.style.display = "block";
                }, 300);
            };

            // Inicializar etiquetas de Materialize
            document.addEventListener('DOMContentLoaded', function () {
                var inputs = document.querySelectorAll('.addForm input');
                inputs.forEach(function (input) {
                    input.addEventListener('focus', function () {
                        var label = this.previousElementSibling;
                        if (label && label.tagName === 'LABEL') {
                            label.style.top = "-25px";
                            label.style.fontSize = "0.9rem";
                            label.style.opacity = "1";
                        }
                    });

                    input.addEventListener('blur', function () {
                        if (this.value === "") {
                            var label = this.previousElementSibling;
                            if (label && label.tagName === 'LABEL') {
                                label.style.top = "-20px";
                                label.style.fontSize = "1rem";
                                label.style.opacity = "0.8";
                            }
                        }
                    });
                });
            });

            // y adaptarlo si es necesario para que funcione en este contexto
            console.log("Inicializando calendario...");

            // El código de inicialización del calendario va aquí
            // Por ahora solo un placeholder
            document.getElementById('month-name').textContent = new Date().toLocaleString('es-ES', { month: 'long' });
            document.getElementById('todayDayName').textContent = 'Hoy es ' + new Date().toLocaleString('es-ES', { weekday: 'long', day: 'numeric', month: 'short' });
        }
    </script>
</body>

</html>